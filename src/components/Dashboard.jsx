import React, { useState, useEffect } from "react";
import {
  home,
  view_plot,
  logout
} from "../assets";
import { useNavigate  } from "react-router-dom";
import "../styles/Dashboard.css";
import LofarPlot from "./LofarPlot"; // Import the LofarPlot component\
import Loading from "./Loading";

export default function Dashboard() {
  const [tableData, setTableData] = useState([]);
  const [momsnCount, setMomsnCount] = useState(0);
  const [showPopup, setShowPopup] = useState(false);
  const [popupData, setPopupData] = useState(null);
  const [showLoading, setShowLoading] = useState(false)
  const navigate = useNavigate();

  useEffect(() => {
    const fetchData = async () => {
      try {
        const response = await fetch("http://13.202.7.118:8000/fetch-history-2/");
        setShowLoading(true);
        if (!response.ok) {
          throw new Error("Failed to fetch data");
        }
        const responseData = await response.json();
        const historyData = responseData.history;
        setTableData(historyData);
        setMomsnCount(responseData.momsn_count);
        setShowLoading(false);
      } catch (error) {
        console.error("Error fetching data:", error);
      }
    };
    fetchData();
  }, []);

  // const handleProceedClick = () => {
  //   navigate("/lofargram");
  // };

  const handleHomeClick = () => {
    navigate("/panel");
  };

  const fetchData = async (momsnStart, momsnEnd) => {
    try {
      const data = {
        momsnStart: momsnStart,
        momsnEnd: momsnEnd,
      };

      const response = await fetch(
        "http://13.202.7.118:8000/rockblock/messages/",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        }
      );

      if (!response.ok) {
        throw new Error("Failed to fetch data from the server");
      }

      const responseData = await response.json();
      // console.log(responseData);

      if (
        !responseData ||
        !responseData.stft_data.T ||
        !responseData.stft_data.F ||
        !responseData.stft_data.Zxx_compressed_resized
      ) {
        throw new Error("No valid data available in the database");
      }

      return responseData;
    } catch (error) {
      throw new Error(
        "Error fetching data/No valid data available in the database"
      );
    }
  };

  const handleViewClick = async (momsnStart, momsnEnd) => {
    try {
      // Show loading state
      setShowLoading(true);
  
      const data = await fetchData(momsnStart, momsnEnd);
  
      // Hide loading state
      setShowLoading(false);
  
      console.log(data);
      //setPopupData(data);
      //setShowPopup(true);
      // Navigate to /viewreport route with data
      navigate("/viewreport", { state: data }); // Pass data as state
    } catch (error) {
      // Hide loading state in case of error
      setShowLoading(false);
  
      console.error("Error fetching data:", error);
      alert(error.message);
    }
  };
  

  const handleClosePopup = () => {
    setShowPopup(false);
    setPopupData(null);
  };

  const handleLogout = () => {
    navigate("/");
  };

  return (
    <div className="container">
      <img
        src={home}
        alt="Show Plot"
        onClick={handleHomeClick}
        className="home-image"
      />
      <svg width="280" height="160" viewBox="0 -10 300 87" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M4.584 21V8.328H0.552V6.048H11.424V8.328H7.176V21H4.584ZM20.376 21.24C19.384 21.24 18.48 21 17.664 20.52C16.864 20.024 16.232 19.344 15.768 18.48C15.304 17.6 15.072 16.576 15.072 15.408C15.072 14.304 15.304 13.312 15.768 12.432C16.232 11.552 16.864 10.856 17.664 10.344C18.48 9.832 19.384 9.576 20.376 9.576C21.384 9.576 22.288 9.832 23.088 10.344C23.904 10.856 24.544 11.552 25.008 12.432C25.488 13.312 25.728 14.304 25.728 15.408C25.728 16.56 25.488 17.576 25.008 18.456C24.544 19.336 23.904 20.024 23.088 20.52C22.288 21 21.384 21.24 20.376 21.24ZM20.376 19.08C21.144 19.08 21.776 18.744 22.272 18.072C22.768 17.384 23.016 16.496 23.016 15.408C23.016 14.288 22.768 13.4 22.272 12.744C21.776 12.088 21.144 11.76 20.376 11.76C19.64 11.76 19.024 12.088 18.528 12.744C18.032 13.4 17.784 14.288 17.784 15.408C17.784 16.496 18.024 17.384 18.504 18.072C19 18.744 19.624 19.08 20.376 19.08ZM35.976 21.24C35.112 21.24 34.4 21.056 33.84 20.688C33.28 20.304 32.872 19.672 32.616 18.792C32.36 17.912 32.264 16.72 32.328 15.216L32.448 11.976H30.168L30.216 9.84H32.544L32.64 7.2L35.448 6.84L35.664 6.816L35.688 7.032C35.608 7.144 35.536 7.264 35.472 7.392C35.424 7.504 35.392 7.688 35.376 7.944L35.208 9.84H38.808L38.784 11.976H35.184L35.04 15.168C34.992 16.208 35.024 17.008 35.136 17.568C35.264 18.128 35.448 18.52 35.688 18.744C35.944 18.952 36.248 19.056 36.6 19.056C37.112 19.056 37.568 18.952 37.968 18.744C38.384 18.536 38.768 18.296 39.12 18.024L39.696 19.992C39.136 20.392 38.552 20.704 37.944 20.928C37.336 21.136 36.68 21.24 35.976 21.24ZM47.952 21.288C46.72 21.288 45.76 21 45.072 20.424C44.4 19.848 44.064 19.088 44.064 18.144C44.064 16.96 44.592 15.984 45.648 15.216C46.72 14.432 48.272 14.04 50.304 14.04C50.416 14.04 50.56 14.04 50.736 14.04C50.928 14.04 51.128 14.048 51.336 14.064C51.224 13.136 50.96 12.512 50.544 12.192C50.128 11.856 49.568 11.688 48.864 11.688C48.352 11.688 47.872 11.776 47.424 11.952C46.976 12.112 46.528 12.416 46.08 12.864L44.592 11.232C45.232 10.64 45.928 10.216 46.68 9.96C47.432 9.704 48.2 9.576 48.984 9.576C49.912 9.576 50.76 9.728 51.528 10.032C52.296 10.32 52.904 10.832 53.352 11.568C53.8 12.288 54.024 13.288 54.024 14.568V21H51.216V19.8C50.8 20.36 50.32 20.752 49.776 20.976C49.232 21.184 48.624 21.288 47.952 21.288ZM46.776 17.808C46.776 18.32 46.936 18.68 47.256 18.888C47.592 19.08 48 19.176 48.48 19.176C49.344 19.176 50.016 18.92 50.496 18.408C50.976 17.88 51.264 17.056 51.36 15.936C51.152 15.936 50.952 15.936 50.76 15.936C50.568 15.92 50.4 15.912 50.256 15.912C48.976 15.912 48.072 16.088 47.544 16.44C47.032 16.792 46.776 17.248 46.776 17.808ZM59.112 21V18.864H62.256V7.032H59.256V4.896H64.992V18.864H68.112V21H59.112ZM87.552 21V6.048H92.64C93.792 6.048 94.744 6.248 95.496 6.648C96.248 7.048 96.8 7.584 97.152 8.256C97.52 8.912 97.704 9.64 97.704 10.44C97.704 11.224 97.528 11.944 97.176 12.6C96.824 13.24 96.28 13.76 95.544 14.16C94.808 14.544 93.88 14.736 92.76 14.736H90.312V21H87.552ZM90.312 12.48H92.568C93.336 12.48 93.92 12.288 94.32 11.904C94.72 11.52 94.92 11.032 94.92 10.44C94.92 9.848 94.72 9.36 94.32 8.976C93.92 8.592 93.344 8.4 92.592 8.4H90.312V12.48ZM105.552 21.288C104.32 21.288 103.36 21 102.672 20.424C102 19.848 101.664 19.088 101.664 18.144C101.664 16.96 102.192 15.984 103.248 15.216C104.32 14.432 105.872 14.04 107.904 14.04C108.016 14.04 108.16 14.04 108.336 14.04C108.528 14.04 108.728 14.048 108.936 14.064C108.824 13.136 108.56 12.512 108.144 12.192C107.728 11.856 107.168 11.688 106.464 11.688C105.952 11.688 105.472 11.776 105.024 11.952C104.576 12.112 104.128 12.416 103.68 12.864L102.192 11.232C102.832 10.64 103.528 10.216 104.28 9.96C105.032 9.704 105.8 9.576 106.584 9.576C107.512 9.576 108.36 9.728 109.128 10.032C109.896 10.32 110.504 10.832 110.952 11.568C111.4 12.288 111.624 13.288 111.624 14.568V21H108.816V19.8C108.4 20.36 107.92 20.752 107.376 20.976C106.832 21.184 106.224 21.288 105.552 21.288ZM104.376 17.808C104.376 18.32 104.536 18.68 104.856 18.888C105.192 19.08 105.6 19.176 106.08 19.176C106.944 19.176 107.616 18.92 108.096 18.408C108.576 17.88 108.864 17.056 108.96 15.936C108.752 15.936 108.552 15.936 108.36 15.936C108.168 15.92 108 15.912 107.856 15.912C106.576 15.912 105.672 16.088 105.144 16.44C104.632 16.792 104.376 17.248 104.376 17.808ZM121.872 21.288C120.784 21.288 119.808 21.04 118.944 20.544C118.08 20.048 117.392 19.368 116.88 18.504C116.384 17.624 116.136 16.624 116.136 15.504C116.136 14.4 116.384 13.4 116.88 12.504C117.392 11.608 118.08 10.896 118.944 10.368C119.808 9.84 120.792 9.576 121.896 9.576C122.92 9.576 123.816 9.768 124.584 10.152C125.352 10.536 125.96 11.064 126.408 11.736L124.896 13.392L124.752 13.56L124.56 13.416C124.56 13.272 124.544 13.144 124.512 13.032C124.48 12.904 124.376 12.736 124.2 12.528C123.896 12.24 123.552 12.04 123.168 11.928C122.8 11.816 122.384 11.76 121.92 11.76C121.392 11.76 120.896 11.904 120.432 12.192C119.968 12.48 119.592 12.904 119.304 13.464C119.032 14.024 118.896 14.704 118.896 15.504C118.896 16.224 119.04 16.856 119.328 17.4C119.616 17.928 119.992 18.344 120.456 18.648C120.936 18.936 121.448 19.08 121.992 19.08C122.488 19.08 122.976 18.976 123.456 18.768C123.936 18.56 124.384 18.2 124.8 17.688L126.312 19.416C125.72 20.072 125.032 20.552 124.248 20.856C123.464 21.144 122.672 21.288 121.872 21.288ZM134.496 15.936L133.608 16.824V21H130.848V4.896H133.8V5.112C133.704 5.208 133.648 5.32 133.632 5.448C133.616 5.56 133.608 5.744 133.608 6V13.872L137.88 9.744C138.12 9.792 138.4 9.832 138.72 9.864C139.04 9.896 139.304 9.912 139.512 9.912H140.808L136.368 14.256L141.408 20.976L138.312 21.096L134.496 15.936ZM150.504 21.264C149.432 21.264 148.472 21.04 147.624 20.592C146.792 20.144 146.136 19.488 145.656 18.624C145.176 17.76 144.936 16.72 144.936 15.504C144.936 14.256 145.168 13.192 145.632 12.312C146.112 11.432 146.744 10.76 147.528 10.296C148.328 9.816 149.216 9.576 150.192 9.576C151.056 9.576 151.848 9.776 152.568 10.176C153.304 10.576 153.888 11.184 154.32 12C154.768 12.8 154.992 13.8 154.992 15C154.992 15.16 154.984 15.352 154.968 15.576C154.968 15.8 154.96 15.992 154.944 16.152H147.552C147.584 16.856 147.752 17.432 148.056 17.88C148.36 18.312 148.736 18.632 149.184 18.84C149.632 19.048 150.112 19.152 150.624 19.152C151.12 19.152 151.592 19.072 152.04 18.912C152.488 18.752 152.904 18.48 153.288 18.096L154.68 19.44C154.136 20.08 153.512 20.544 152.808 20.832C152.104 21.12 151.336 21.264 150.504 21.264ZM147.6 14.112H152.352C152.352 13.328 152.152 12.728 151.752 12.312C151.352 11.896 150.792 11.688 150.072 11.688C149.448 11.688 148.904 11.888 148.44 12.288C147.976 12.672 147.696 13.28 147.6 14.112ZM165.576 21.24C164.712 21.24 164 21.056 163.44 20.688C162.88 20.304 162.472 19.672 162.216 18.792C161.96 17.912 161.864 16.72 161.928 15.216L162.048 11.976H159.768L159.816 9.84H162.144L162.24 7.2L165.048 6.84L165.264 6.816L165.288 7.032C165.208 7.144 165.136 7.264 165.072 7.392C165.024 7.504 164.992 7.688 164.976 7.944L164.808 9.84H168.408L168.384 11.976H164.784L164.64 15.168C164.592 16.208 164.624 17.008 164.736 17.568C164.864 18.128 165.048 18.52 165.288 18.744C165.544 18.952 165.848 19.056 166.2 19.056C166.712 19.056 167.168 18.952 167.568 18.744C167.984 18.536 168.368 18.296 168.72 18.024L169.296 19.992C168.736 20.392 168.152 20.704 167.544 20.928C166.936 21.136 166.28 21.24 165.576 21.24ZM188.28 21V6.048H193.008C194.832 6.048 196.168 6.448 197.016 7.248C197.864 8.048 198.288 9.112 198.288 10.44C198.288 10.984 198.168 11.536 197.928 12.096C197.704 12.64 197.376 13.128 196.944 13.56C196.528 13.992 196.04 14.312 195.48 14.52L198.696 21H195.84L192.816 14.784H191.016V21H188.28ZM191.016 12.528H193.2C193.968 12.528 194.544 12.352 194.928 12C195.312 11.632 195.504 11.136 195.504 10.512C195.504 9.936 195.312 9.44 194.928 9.024C194.544 8.608 193.968 8.4 193.2 8.4H191.016V12.528ZM208.104 21.264C207.032 21.264 206.072 21.04 205.224 20.592C204.392 20.144 203.736 19.488 203.256 18.624C202.776 17.76 202.536 16.72 202.536 15.504C202.536 14.256 202.768 13.192 203.232 12.312C203.712 11.432 204.344 10.76 205.128 10.296C205.928 9.816 206.816 9.576 207.792 9.576C208.656 9.576 209.448 9.776 210.168 10.176C210.904 10.576 211.488 11.184 211.92 12C212.368 12.8 212.592 13.8 212.592 15C212.592 15.16 212.584 15.352 212.568 15.576C212.568 15.8 212.56 15.992 212.544 16.152H205.152C205.184 16.856 205.352 17.432 205.656 17.88C205.96 18.312 206.336 18.632 206.784 18.84C207.232 19.048 207.712 19.152 208.224 19.152C208.72 19.152 209.192 19.072 209.64 18.912C210.088 18.752 210.504 18.48 210.888 18.096L212.28 19.44C211.736 20.08 211.112 20.544 210.408 20.832C209.704 21.12 208.936 21.264 208.104 21.264ZM205.2 14.112H209.952C209.952 13.328 209.752 12.728 209.352 12.312C208.952 11.896 208.392 11.688 207.672 11.688C207.048 11.688 206.504 11.888 206.04 12.288C205.576 12.672 205.296 13.28 205.2 14.112ZM222.672 21.288C221.584 21.288 220.608 21.04 219.744 20.544C218.88 20.048 218.192 19.368 217.68 18.504C217.184 17.624 216.936 16.624 216.936 15.504C216.936 14.4 217.184 13.4 217.68 12.504C218.192 11.608 218.88 10.896 219.744 10.368C220.608 9.84 221.592 9.576 222.696 9.576C223.72 9.576 224.616 9.768 225.384 10.152C226.152 10.536 226.76 11.064 227.208 11.736L225.696 13.392L225.552 13.56L225.36 13.416C225.36 13.272 225.344 13.144 225.312 13.032C225.28 12.904 225.176 12.736 225 12.528C224.696 12.24 224.352 12.04 223.968 11.928C223.6 11.816 223.184 11.76 222.72 11.76C222.192 11.76 221.696 11.904 221.232 12.192C220.768 12.48 220.392 12.904 220.104 13.464C219.832 14.024 219.696 14.704 219.696 15.504C219.696 16.224 219.84 16.856 220.128 17.4C220.416 17.928 220.792 18.344 221.256 18.648C221.736 18.936 222.248 19.08 222.792 19.08C223.288 19.08 223.776 18.976 224.256 18.768C224.736 18.56 225.184 18.2 225.6 17.688L227.112 19.416C226.52 20.072 225.832 20.552 225.048 20.856C224.264 21.144 223.472 21.288 222.672 21.288ZM236.904 21.264C235.832 21.264 234.872 21.04 234.024 20.592C233.192 20.144 232.536 19.488 232.056 18.624C231.576 17.76 231.336 16.72 231.336 15.504C231.336 14.256 231.568 13.192 232.032 12.312C232.512 11.432 233.144 10.76 233.928 10.296C234.728 9.816 235.616 9.576 236.592 9.576C237.456 9.576 238.248 9.776 238.968 10.176C239.704 10.576 240.288 11.184 240.72 12C241.168 12.8 241.392 13.8 241.392 15C241.392 15.16 241.384 15.352 241.368 15.576C241.368 15.8 241.36 15.992 241.344 16.152H233.952C233.984 16.856 234.152 17.432 234.456 17.88C234.76 18.312 235.136 18.632 235.584 18.84C236.032 19.048 236.512 19.152 237.024 19.152C237.52 19.152 237.992 19.072 238.44 18.912C238.888 18.752 239.304 18.48 239.688 18.096L241.08 19.44C240.536 20.08 239.912 20.544 239.208 20.832C238.504 21.12 237.736 21.264 236.904 21.264ZM234 14.112H238.752C238.752 13.328 238.552 12.728 238.152 12.312C237.752 11.896 237.192 11.688 236.472 11.688C235.848 11.688 235.304 11.888 234.84 12.288C234.376 12.672 234.096 13.28 234 14.112ZM246.816 21V18.864H249.552V11.976H246.96V9.84H252.288V18.864H254.784V21H246.816ZM250.8 7.992C250.32 7.992 249.912 7.832 249.576 7.512C249.256 7.192 249.096 6.808 249.096 6.36C249.096 5.896 249.256 5.512 249.576 5.208C249.896 4.888 250.304 4.728 250.8 4.728C251.248 4.728 251.64 4.888 251.976 5.208C252.328 5.528 252.504 5.912 252.504 6.36C252.504 6.808 252.328 7.192 251.976 7.512C251.64 7.832 251.248 7.992 250.8 7.992ZM264.096 21L259.896 9.84H262.728L265.416 17.352L266.712 14.184C267.016 13.416 267.256 12.672 267.432 11.952C267.624 11.216 267.744 10.512 267.792 9.84H270.336C270.256 10.544 270.08 11.296 269.808 12.096C269.552 12.88 269.256 13.68 268.92 14.496L266.232 21H264.096ZM280.104 21.264C279.032 21.264 278.072 21.04 277.224 20.592C276.392 20.144 275.736 19.488 275.256 18.624C274.776 17.76 274.536 16.72 274.536 15.504C274.536 14.256 274.768 13.192 275.232 12.312C275.712 11.432 276.344 10.76 277.128 10.296C277.928 9.816 278.816 9.576 279.792 9.576C280.656 9.576 281.448 9.776 282.168 10.176C282.904 10.576 283.488 11.184 283.92 12C284.368 12.8 284.592 13.8 284.592 15C284.592 15.16 284.584 15.352 284.568 15.576C284.568 15.8 284.56 15.992 284.544 16.152H277.152C277.184 16.856 277.352 17.432 277.656 17.88C277.96 18.312 278.336 18.632 278.784 18.84C279.232 19.048 279.712 19.152 280.224 19.152C280.72 19.152 281.192 19.072 281.64 18.912C282.088 18.752 282.504 18.48 282.888 18.096L284.28 19.44C283.736 20.08 283.112 20.544 282.408 20.832C281.704 21.12 280.936 21.264 280.104 21.264ZM277.2 14.112H281.952C281.952 13.328 281.752 12.728 281.352 12.312C280.952 11.896 280.392 11.688 279.672 11.688C279.048 11.688 278.504 11.888 278.04 12.288C277.576 12.672 277.296 13.28 277.2 14.112ZM293.424 21.264C292.592 21.264 291.824 21.048 291.12 20.616C290.432 20.184 289.872 19.528 289.44 18.648C289.008 17.768 288.792 16.672 288.792 15.36C288.792 14.064 289 12.992 289.416 12.144C289.832 11.28 290.392 10.632 291.096 10.2C291.8 9.768 292.584 9.552 293.448 9.552C294.008 9.552 294.528 9.656 295.008 9.864C295.488 10.072 295.864 10.408 296.136 10.872V4.896H299.04V5.112C298.944 5.208 298.88 5.32 298.848 5.448C298.832 5.56 298.824 5.744 298.824 6L298.8 19.512C298.8 19.768 298.816 20.016 298.848 20.256C298.88 20.496 298.952 20.744 299.064 21H296.4C296.272 20.744 296.2 20.544 296.184 20.4C296.168 20.24 296.16 20.032 296.16 19.776C295.856 20.288 295.464 20.664 294.984 20.904C294.504 21.144 293.984 21.264 293.424 21.264ZM293.88 19.08C295.352 19.08 296.088 17.848 296.088 15.384C296.088 12.904 295.328 11.664 293.808 11.664C293.04 11.664 292.456 11.992 292.056 12.648C291.656 13.304 291.456 14.192 291.456 15.312C291.456 16.496 291.688 17.424 292.152 18.096C292.632 18.752 293.208 19.08 293.88 19.08Z" fill="#0CFEFF"/>
        <rect x="4" y="40" width="292" height="66" fill="url(#paint0_linear_465_1960)" stroke="#09B5FE" stroke-width="2"/>
        <defs>
        <linearGradient id="paint0_linear_465_1960" x1="364.523" y1="-13.2404" x2="237.662" y2="248.439" gradientUnits="userSpaceOnUse">
        <stop offset="0.169223" stop-color="#00092A" stop-opacity="0.77"/>
        <stop offset="0.861292" stop-color="#004970"/>
        <stop offset="1" stop-color="#004970" stop-opacity="0"/>
        </linearGradient>
        </defs>
        <text x="130" y="90" font-family="Digital Number" font-size="50" fill="#a8f2ff" className="digital-text">
          {momsnCount}
        </text>
      </svg>
      <table className="data-table">
        <thead>
          <tr>
            <th>BUOY ID</th>
            <th>Message ID</th>
            <th>Message Sent Time</th>
            <th>Message Received Time</th>
            <th>View</th>
          </tr>
        </thead>
        <tbody>
          {tableData.map((record, index) => (
            <tr key={index}>
              <td>AS-D 6891</td>
              <td>
                {record.momsn_start} - {record.momsn_end}
              </td>
              <td>{record.transmit_start}</td>
              <td>{record.transmit_end}</td>
              <td>
                <img
                  src={view_plot}
                  alt=""
                  onClick={() =>
                    handleViewClick(record.momsn_start, record.momsn_end)
                  }
                />
              </td>
            </tr>
          ))}
        </tbody>
      </table>
      <div className="btn-container">
        <img onClick={handleLogout} src={logout} alt="" srcset="" />
      </div>
      {showPopup && (
        <div className="popup">
          <div className="popup-content">
            <span className="close" onClick={handleClosePopup}>
              &times;
            </span>
            <LofarPlot data={popupData.stft_data} />
          </div>
        </div>
      )}
      {showLoading && <Loading />}
    </div>
  );
}
